Bootstrap: docker
From: ubuntu:24.04

%files
    spix_1007.yml /tmp/spix_1007.yml

%post
    set -eux
    
    # Update package manager
    apt-get update
    apt-get upgrade -y
    
    # Install essential build tools
    apt-get install -y --no-install-recommends \
        build-essential \
        python3-dev \
        gcc \
        g++ \
        git \
        wget \
        curl
    
    # Clean up apt cache to reduce image size
    apt-get clean
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*
    
    # Install conda via apt-get
    # Doing this because I'm too lazy to get HPC admin to change their network access
    apt-get install -y --no-install-recommends \
        conda \
        mamba
    
    # Initialize conda
    conda init bash
    
    # Update conda base environment
    conda config --system --prepend channels conda-forge
    conda update -n base -c defaults conda -y
    
    # Create and activate the spix environment from YAML
    conda env create -f /tmp/spix_1007.yml
    
    # Clean conda cache
    conda clean --all --yes
    
    # Verify installation
    conda env list

%environment
    export PATH="/opt/conda/envs/spix_1007/bin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    export CONDA_DEFAULT_ENV=spix_1007
    export CONDA_PREFIX=/opt/conda/envs/spix_1007
    export PYTHONUNBUFFERED=1
    export HOME=/home/appuser

%runscript
    # Activate the spix environment and run the command
    eval "$(conda shell.bash hook)"
    conda activate spix_1007
    exec "$@"
