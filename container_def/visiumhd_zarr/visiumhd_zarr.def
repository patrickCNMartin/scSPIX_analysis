Bootstrap: docker
From: ubuntu:24.04

%files
    visiumhd_zarr.yml /tmp/visiumhd_zarr.yml

%post
    set -eux
    
    # Update package manager
    apt-get update
    apt-get upgrade -y
    
    # Install essential build tools
    apt-get install -y --no-install-recommends \
        build-essential \
        python3-dev \
        gcc \
        g++ \
        git \
        wget \
        curl \
        conda \
        mamba
    
    # Clean up apt cache to reduce image size
    apt-get clean
    rm -rf /var/lib/apt/lists/* /var/cache/apt/*
    
    # Initialize conda
    conda init bash
    
    # Update conda base environment
    conda config --system --prepend channels conda-forge
    conda update -n base -c defaults conda -y
    
    # Create and activate the stereopy environment from YAML
    conda env create -f /tmp/visiumhd_zarr.yml
    
    # Clean conda cache
    conda clean --all --yes
    
    # Verify installation
    conda env list

%environment
    export PATH="/opt/conda/envs/stereopy/bin:/opt/conda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    export CONDA_DEFAULT_ENV=stereopy
    export CONDA_PREFIX=/opt/conda/envs/stereopy
    export PYTHONUNBUFFERED=1
    export HOME=/home/appuser

%runscript
    # Activate the stereopy environment and run the command
    eval "$(conda shell.bash hook)"
    conda activate stereopy
    exec "$@"