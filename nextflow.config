nextflow.enable.dsl=2

/* ---------------------------------------------------------
 * Project & Directories
 * --------------------------------------------------------- */

projectDir = file("${baseDir}/..")
workDir    = "${projectDir}/work"

params {

    /* -----------------------------------------------------
     * General Output
     * ----------------------------------------------------- */
    outdir = "${projectDir}/report"

    /* -----------------------------------------------------
     * Execution Flags (enable/disable dataset workflows)
     * ----------------------------------------------------- */
    run_data_download = false
    run_container_check = false
    run_stereo    = false
    run_visiumhd  = false

    /* -----------------------------------------------------
     * Dataset Input Paths
     * ----------------------------------------------------- */

    // --- Stereo-seq inputs ---
    stereo = [
        input_gem_file : '',
        script_dir     : "${projectDir}/bin/stereopy/",
        bin_size       : 3
    ]

    // --- VisiumHD inputs ---
    visiumhd = [
        input_dir          : '',
        input_8um_h5ad     : '',
        script_dir         : "${projectDir}/bin/visiumhd_zarr",
        bin_size           : 2
    ]

    /* -----------------------------------------------------
     * pre-built containers
     * The definition files and environment files are also
     * available.
     * ----------------------------------------------------- */
    container_cache_dir = "${projectDir}/container_cache"

    containers = [
        stereo_conversion   : '${params.container_cache_dir}/spix-conversion-stereo.tar',
        visiumhd_conversion : '${params.container_cache_dir}/spix-conversion-visiumhd.tar',
        analysis            : '${params.container_cache_dir}/spix-analysis.tar'
    ]
}


/* ---------------------------------------------------------
 * Process Configuration (Resources + Containers)
 * --------------------------------------------------------- */

process {

    executor      = 'local'
    errorStrategy = 'retry'
    maxRetries    = 2
    echo          = true

    /* -----------------------------------------------------
     * Resource Profiles with Thread Counts (universal)
     * ----------------------------------------------------- */
    withLabel: 'conversion_single' {
        cpus   = 2
        memory = '8 GB'
        time   = '2h'
        env {
            OMP_NUM_THREADS       = '${task.cpus}'
            OPENBLAS_NUM_THREADS  = '${task.cpus}'
            MKL_NUM_THREADS       = '${task.cpus}'
            NUMEXPR_NUM_THREADS   = '${task.cpus}'
        }
    }

    withLabel: 'conversion_medium' {
        cpus   = 8
        memory = '32 GB'
        time   = '6h'
        env {
            OMP_NUM_THREADS       = '${task.cpus}'
            OPENBLAS_NUM_THREADS  = '${task.cpus}'
            MKL_NUM_THREADS       = '${task.cpus}'
            NUMEXPR_NUM_THREADS   = '${task.cpus}'
        }
    }

    withLabel: 'process_large' {
        cpus   = 32
        memory = '128 GB'
        time   = '24h'
        env {
            OMP_NUM_THREADS       = '${task.cpus}'
            OPENBLAS_NUM_THREADS  = '${task.cpus}'
            MKL_NUM_THREADS       = '${task.cpus}'
            NUMEXPR_NUM_THREADS   = '${task.cpus}'
        }
    }

    /* -----------------------------------------------------
     * Container Mapping (Per Dataset Category)
     * ----------------------------------------------------- */

    // Stereo-seq
    withLabel: 'stereo_conversion' {
        container = "${params.container_cache_dir}/${params.containers.stereo_conversion.replace('.tar','.sif')}"
    }

    // VisiumHD
    withLabel: 'visiumhd_conversion' {
        container = "${params.container_cache_dir}/${params.containers.visiumhd_conversion.replace('.tar','.sif')}"
    }

    // Shared analysis container
    withLabel: 'analysis' {
        container = "${params.container_cache_dir}/${params.containers.analysis.replace('.tar','.sif')}"
    }
}


/* ---------------------------------------------------------
 * Workflow & Run Behavior
 * --------------------------------------------------------- */

workflow.onError = 'exit'


/* ---------------------------------------------------------
 * Reporting - to be added later when building final reports
 * --------------------------------------------------------- */



/* ---------------------------------------------------------
 * Container Engines
 * --------------------------------------------------------- */

docker {
    enabled    = false
    runOptions = '-u $(id -u):$(id -g)'
}

singularity {
    enabled     = false
    autoMounts  = true
    runOptions  = '--containall'
    cacheDir    = "${params.container_cache_dir}"
}


/* ---------------------------------------------------------
 * Profiles (Local, Docker, Singularity, SLURM, Condor, AWS)
 * --------------------------------------------------------- */

profiles {

    docker_local {
        process.executor = 'local'
        docker.enabled   = true
        singularity.enabled = false
        cpus   = 2
        memory = '8 GB'
        time   = '2h'
    }

    slurm {
        singularity.enabled = true
        docker.enabled      = false
        singularity.cacheDir = "${projectDir}/container_cache"
        process {
            executor = 'slurm'
            queue = 'defq'
        }

        process {
            withLabel: 'conversion_single' {
                clusterOptions = '--time=2:00:00 --mem-per-cpu=4G'
            }

            withLabel: 'conversion_medium' {
                clusterOptions = '--time=6:00:00 --mem-per-cpu=4G'
            }

            withLabel: 'process_large' {
                clusterOptions = '--time=24:00:00 --mem-per-cpu=4G'
            }
        }
    }
}